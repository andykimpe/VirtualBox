From 3c981196de564d78aa8c653496f7fefe303bf7b6 Mon Sep 17 00:00:00 2001
From: vboxsync <vboxsync@cfe28804-0f27-0410-a406-dd0f0b0b656f>
Date: Thu, 23 Jul 2020 11:58:10 +0000
Subject: [PATCH] SUPDrv/supdrvOSChangeCR4: Adjustments for 5.8.  bugref:9801

git-svn-id: http://www.virtualbox.org/svn/vbox@85431 cfe28804-0f27-0410-a406-dd0f0b0b656f
---
 .../HostDrivers/Support/linux/SUPDrv-linux.c  | 19 ++++++++++++-------
 1 file changed, 12 insertions(+), 7 deletions(-)

diff --git a/trunk/src/VBox/HostDrivers/Support/linux/SUPDrv-linux.c b/trunk/src/VBox/HostDrivers/Support/linux/SUPDrv-linux.c
index 02cea26f02..16f6e9fc9e 100644
--- a/trunk/src/VBox/HostDrivers/Support/linux/SUPDrv-linux.c
+++ b/trunk/src/VBox/HostDrivers/Support/linux/SUPDrv-linux.c
@@ -756,20 +756,25 @@ EXPORT_SYMBOL(SUPDrvLinuxIDC);
 
 RTCCUINTREG VBOXCALL supdrvOSChangeCR4(RTCCUINTREG fOrMask, RTCCUINTREG fAndMask)
 {
-#if LINUX_VERSION_CODE >= KERNEL_VERSION(3, 20, 0)
-    RTCCUINTREG uOld = this_cpu_read(cpu_tlbstate.cr4);
-    RTCCUINTREG uNew = (uOld & fAndMask) | fOrMask;
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(5, 8, 0)
+    RTCCUINTREG const uOld = __read_cr4();
+#elif LINUX_VERSION_CODE >= KERNEL_VERSION(3, 20, 0)
+    RTCCUINTREG const uOld = this_cpu_read(cpu_tlbstate.cr4);
+#else
+    RTCCUINTREG const uOld = ASMGetCR4();
+#endif
+    RTCCUINTREG const uNew = (uOld & fAndMask) | fOrMask;
     if (uNew != uOld)
     {
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(5, 8, 0)
+        ASMSetCR4(uNew);
+#elif LINUX_VERSION_CODE >= KERNEL_VERSION(3, 20, 0)
         this_cpu_write(cpu_tlbstate.cr4, uNew);
         __write_cr4(uNew);
-    }
 #else
-    RTCCUINTREG uOld = ASMGetCR4();
-    RTCCUINTREG uNew = (uOld & fAndMask) | fOrMask;
-    if (uNew != uOld)
         ASMSetCR4(uNew);
 #endif
+    }
     return uOld;
 }
 
