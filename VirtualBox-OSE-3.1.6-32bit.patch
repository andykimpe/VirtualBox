From c54ef4d0f82d1aa7e0e3bf370265cdf569b1dc26 Mon Sep 17 00:00:00 2001
From: Lubomir Rintel <lkundrak@v3.sk>
Date: Fri, 26 Mar 2010 04:44:55 +0100
Subject: [PATCH] Build on x86_64 without 32bit toolchain.

This disables the check for 32bit toolchain and tests that need it
(boo).
---
 configure                              |    2 +-
 src/VBox/Devices/testcase/Makefile.kmk |    8 ++++++++
 src/VBox/VMM/testcase/Makefile.kmk     |   17 ++++++++++++++---
 3 files changed, 23 insertions(+), 4 deletions(-)

diff --git a/configure b/configure
index 2a29643..69bdc28 100755
--- a/configure
+++ b/configure
@@ -2345,7 +2345,7 @@ if [ "$OS" = "linux" ]; then
   fi
   check_libcap
   check_compiler_h
-  [ "$BUILD_MACHINE" = "amd64" ] && check_32bit
+  #[ "$BUILD_MACHINE" = "amd64" ] && check_32bit
 fi
 
 [ -n "$SETUP_WINE" ] && setup_wine
diff --git a/src/VBox/Devices/testcase/Makefile.kmk b/src/VBox/Devices/testcase/Makefile.kmk
index 2f3e157..cce43ae 100644
--- a/src/VBox/Devices/testcase/Makefile.kmk
+++ b/src/VBox/Devices/testcase/Makefile.kmk
@@ -33,23 +33,29 @@ BLDDIRS += $(VBOX_DEVICES_TEST_OUT_DIR)
 # We setup one 'other' target for executing the structure & alignment
 # validation testcases. Perhaps a bit hackish, but extremely useful.
 #
+ifneq ($(KBUILD_HOST_ARCH),amd64)
 ifeq ($(KBUILD_TARGET),$(KBUILD_HOST))
  ifeq ($(filter-out x86.x86 amd64.amd64 x86.amd64, $(KBUILD_TARGET_ARCH).$(KBUILD_HOST_ARCH)),)
   OTHERS += \
 	$(VBOX_DEVICES_TEST_OUT_DIR)/tstDeviceStructSize.run
  endif
 endif
+endif
 
 # The normal testing pass.
+ifneq ($(KBUILD_HOST_ARCH),amd64)
 TESTING += \
 	$(VBOX_DEVICES_TEST_OUT_DIR)/tstDeviceStructSize.run
+endif
 
 
 ifdef VBOX_WITH_RAW_MODE
  #
  # The testcase generator.
  #
+ifneq ($(KBUILD_HOST_ARCH),amd64)
  PROGRAMS += tstDeviceStructSizeRC
+endif
  tstDeviceStructSizeRC_TEMPLATE  = VBOXGCEXE
  tstDeviceStructSizeRC_DEFS      = VBOX_WITH_RAW_MODE
  ifdef VBOX_WITH_USB
@@ -92,7 +98,9 @@ endif # VBOX_WITH_RAW_MODE
 #
 # The testcase it self.
 #
+ifneq ($(KBUILD_HOST_ARCH),amd64)
 PROGRAMS += tstDeviceStructSize
+endif
 tstDeviceStructSize_TEMPLATE = VBOXR3AUTOTST
 tstDeviceStructSize_DEFS     =
 ifdef VBOX_WITH_USB
diff --git a/src/VBox/VMM/testcase/Makefile.kmk b/src/VBox/VMM/testcase/Makefile.kmk
index 89b5203..9149ffe 100644
--- a/src/VBox/VMM/testcase/Makefile.kmk
+++ b/src/VBox/VMM/testcase/Makefile.kmk
@@ -25,9 +25,15 @@ include	$(KBUILD_PATH)/subheader.kmk
 #
 # Target lists.
 #
-PROGRAMS   += tstVMStructSize tstAsmStructs tstGlobalConfig tstInstrEmul
+PROGRAMS   += tstGlobalConfig tstInstrEmul
+ifneq ($(KBUILD_HOST_ARCH),amd64)
+ PROGRAMS   += tstVMStructSize tstAsmStructs
+endif
 ifdef VBOX_WITH_RAW_MODE
- PROGRAMS  += tstVMStructRC tstAsmStructsRC tstVMM tstVMM-HwAccm
+ PROGRAMS  += tstVMM tstVMM-HwAccm
+ ifneq ($(KBUILD_HOST_ARCH),amd64)
+  PROGRAMS  += tstVMStructRC tstAsmStructsRC
+ endif
  ifneq ($(KBUILD_TARGET),win)
   PROGRAMS += tstVMMFork
  endif
@@ -65,16 +71,21 @@ BLDDIRS += $(VBOX_VMM_TESTCASE_OUT_DIR)
 #
 ifeq ($(KBUILD_TARGET),$(KBUILD_HOST))
  ifeq ($(filter-out x86.x86 amd64.amd64 x86.amd64, $(KBUILD_TARGET_ARCH).$(KBUILD_HOST_ARCH)),)
+  ifneq ($(KBUILD_HOST_ARCH),amd64)
   OTHERS += \
 	$(VBOX_VMM_TESTCASE_OUT_DIR)/tstAsmStructs.run \
 	$(VBOX_VMM_TESTCASE_OUT_DIR)/tstVMStructSize.run
+  endif
  endif
 endif
 
 # The normal testing pass.
+ifneq ($(KBUILD_HOST_ARCH),amd64)
 TESTING += \
 	$(VBOX_VMM_TESTCASE_OUT_DIR)/tstAsmStructs.run \
-	$(VBOX_VMM_TESTCASE_OUT_DIR)/tstVMStructSize.run \
+	$(VBOX_VMM_TESTCASE_OUT_DIR)/tstVMStructSize.run
+endif
+TESTING += \
         $(VBOX_VMM_TESTCASE_OUT_DIR)/tstInstrEmul.run
 
 OTHER_CLEAN += \
-- 
1.7.0.1

