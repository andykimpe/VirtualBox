Based:
Description: Build the X.Org driver only for the selected system X Server version.
Author: Michael Meskes <meskes@debian.org>, Felix Geyer <debfx-pkg@fobos.de>

diff --git a/src/VBox/Additions/common/crOpenGL/Makefile.kmk b/src/VBox/Additions/common/crOpenGL/Makefile.kmk
--- a/src/VBox/Additions/common/crOpenGL/Makefile.kmk
+++ b/src/VBox/Additions/common/crOpenGL/Makefile.kmk
@@ -63,16 +63,12 @@ VBoxOGL_TEMPLATE       = VBOXCROGLR3GUESTDLL
 VBoxOGL_INCS           = .
 if1of ($(KBUILD_TARGET), linux solaris freebsd)
  VBoxOGL_INCS     += \
-	$(VBOX_PATH_X11_ROOT)/libXdamage-1.1 \
-	$(VBOX_PATH_X11_ROOT)/libXcomposite-0.4.0 \
-	$(VBOX_PATH_X11_ROOT)/libXfixes-4.0.3 \
-	$(VBOX_PATH_X11_ROOT)/damageproto-1.1.0 \
-	$(VBOX_PATH_X11_ROOT)/compositeproto-0.4 \
-	$(VBOX_PATH_X11_ROOT)/fixesproto-4.0 \
-	$(VBOX_PATH_X11_ROOT)/libx11-1.1.5-other \
-	$(VBOX_PATH_X11_ROOT)/1.3/xorg \
+	/usr/include/x11 \
+	/usr/include/xorg \
+	/usr/include/pixman-1 \
 	$(VBOX_MESA_INCS) \
-	$(PATH_ROOT)/src/VBox/Additions/x11/x11include/libdrm-2.4.13
+	/usr/include/drm \
+	/usr/include/libdrm
  VBoxOGL_DEFS     += VBOX_NO_NATIVEGL
 endif
 
diff --git a/src/VBox/Additions/x11/Makefile.kmk b/src/VBox/Additions/x11/Makefile.kmk
--- a/src/VBox/Additions/x11/Makefile.kmk
+++ b/src/VBox/Additions/x11/Makefile.kmk
@@ -17,6 +17,10 @@
 SUB_DEPTH = ../../../..
 include $(KBUILD_PATH)/subheader.kmk
 
+ifn1of ($(XSERVER_VERSION), 13 14 15 16 17 18 19 110)
+ XSERVER_VERSION := 17
+endif
+
 # Include sub-makefiles.
 if1of ($(KBUILD_TARGET), freebsd linux netbsd openbsd solaris)
  include $(PATH_SUB_CURRENT)/VBoxClient/Makefile.kmk
diff --git a/src/VBox/Additions/x11/vboxmouse/Makefile.kmk b/src/VBox/Additions/x11/vboxmouse/Makefile.kmk
--- a/src/VBox/Additions/x11/vboxmouse/Makefile.kmk
+++ b/src/VBox/Additions/x11/vboxmouse/Makefile.kmk
@@ -56,6 +56,18 @@
 endif
 
 
+ifeq ($(KBUILD_TARGET), linux)
+DLLS += vboxmouse_drv_$(XSERVER_VERSION)
+vboxmouse_drv_$(XSERVER_VERSION)_TEMPLATE = VBOXGUESTR3XORGMOD
+vboxmouse_drv_$(XSERVER_VERSION)_DEFS = XFree86Server IN_MODULE XFree86Module XFree86LOADER XINPUT XORG_7X IN_XF86_MODULE \
+		NO_ANSIC
+vboxmouse_drv_$(XSERVER_VERSION)_INCS := \
+   /usr/include/x11 \
+   /usr/include/xorg \
+   /usr/include/pixman-1
+vboxmouse_drv_$(XSERVER_VERSION) = \
+	vboxmouse_15.c
+else
 #
 # vboxmouse_drv_70
 #
@@ -154,7 +166,6 @@
 	vboxmouse_15.c
 
 
-ifneq ($(KBUILD_TARGET), linux)
 
 #
 # vboxmouse_drv_17
@@ -256,6 +267,8 @@
 	$(QUIET)$(APPEND) -t "$@" "done"
      endif
 
+ifneq ($(KBUILD_TARGET), linux)
+
      TESTING += $(vboxmouse_drv_70_0_OUTDIR)/tstvboxmouse70.run
      OTHERS += $(vboxmouse_drv_70_0_OUTDIR)/tstvboxmouse70.run
 $$(vboxmouse_drv_70_0_OUTDIR)/tstvboxmouse70.run: $$(vboxmouse_drv_70_1_STAGE_TARGET)
@@ -304,8 +317,6 @@
 	    $(vboxmouse_drv_16_1_STAGE_TARGET) $(VBOXMOUSE_SRC_PATH)/undefined_15
 	$(QUIET)$(APPEND) -t "$@" "done"
 
-ifneq ($(KBUILD_TARGET), linux)
-
      TESTING += $(vboxmouse_drv_17_0_OUTDIR)/tstvboxmouse17.run
      OTHERS += $(vboxmouse_drv_17_0_OUTDIR)/tstvboxmouse17.run
 $$(vboxmouse_drv_17_0_OUTDIR)/tstvboxmouse17.run: $$(vboxmouse_drv_17_1_STAGE_TARGET)
--- a/src/VBox/Additions/x11/vboxvideo/Makefile.kmk
+++ b/src/VBox/Additions/x11/vboxvideo/Makefile.kmk
@@ -89,7 +89,7 @@ vboxvideo_drv_SOURCES = \
 #         base keywords instead of using .solaris or .linux.
 #         Also it is *important* to use := and not = when deriving a property.
 #
-DLLS += vboxvideo_drv_70
+#DLLS += vboxvideo_drv_70
 vboxvideo_drv_70_TEMPLATE = VBOXGUESTR3XORGMOD
 if1of ($(KBUILD_TARGET), linux)
  vboxvideo_drv_70_CFLAGS += \
@@ -112,7 +112,7 @@ vboxvideo_drv_70_SOURCES  = $(vboxvideo_drv_SOURCES)
 #
 # vboxvideo_drv_71
 #
-DLLS += vboxvideo_drv_71
+#DLLS += vboxvideo_drv_71
 vboxvideo_drv_71_TEMPLATE = VBOXGUESTR3XORGMOD
 vboxvideo_drv_71_CFLAGS := $(vboxvideo_drv_70_CFLAGS)
 vboxvideo_drv_71_DEFS := $(vboxvideo_drv_70_DEFS)
@@ -127,7 +127,7 @@ vboxvideo_drv_71_SOURCES  = $(vboxvideo_drv_SOURCES)
 #
 # vboxvideo_drv_13
 #
-DLLS += vboxvideo_drv_13
+#DLLS += vboxvideo_drv_13
 vboxvideo_drv_13_TEMPLATE = VBOXGUESTR3XORGMOD
 vboxvideo_drv_13_CFLAGS := $(vboxvideo_drv_70_CFLAGS)
 vboxvideo_drv_13_DEFS := $(vboxvideo_drv_70_DEFS) VBOXVIDEO_13
@@ -146,7 +146,7 @@ vboxvideo_drv_13_SOURCES = $(vboxvideo_drv_SOURCES)
 #
 # vboxvideo_drv_14
 #
-DLLS += vboxvideo_drv_14
+#DLLS += vboxvideo_drv_14
 vboxvideo_drv_14_TEMPLATE = VBOXGUESTR3XORGMOD
 vboxvideo_drv_14_CFLAGS := $(vboxvideo_drv_70_CFLAGS)
 vboxvideo_drv_14_DEFS := $(vboxvideo_drv_13_DEFS)
@@ -165,7 +165,7 @@ vboxvideo_drv_14_SOURCES  = $(vboxvideo_drv_SOURCES)
 #
 # vboxvideo_drv_15
 #
-DLLS += vboxvideo_drv_15
+#DLLS += vboxvideo_drv_15
 vboxvideo_drv_15_TEMPLATE = VBOXGUESTR3XORGMOD
 vboxvideo_drv_15_CFLAGS := $(vboxvideo_drv_70_CFLAGS)
 vboxvideo_drv_15_DEFS := $(vboxvideo_drv_13_DEFS) NO_ANSIC PCIACCESS \
@@ -192,7 +192,7 @@ endif
 #
 # vboxvideo_drv_16
 #
-DLLS += vboxvideo_drv_16
+#DLLS += vboxvideo_drv_16
 vboxvideo_drv_16_TEMPLATE = VBOXGUESTR3XORGMOD
 vboxvideo_drv_16_CFLAGS := $(vboxvideo_drv_70_CFLAGS)
 vboxvideo_drv_16_DEFS := $(vboxvideo_drv_15_DEFS)
@@ -218,20 +218,32 @@ vboxvideo_drv_17_CFLAGS := $(vboxvideo_drv_70_CFLAGS)
 vboxvideo_drv_17_DEFS := $(vboxvideo_drv_15_DEFS)
 ## @todo replace $(VBOX_PATH_X11_ROOT)/xorg-server-1.6.0-local
 vboxvideo_drv_17_INCS = \
-	$(VBOX_PATH_X11_ROOT)/fontsproto-2.1.0 \
-	$(VBOX_PATH_X11_ROOT)/glproto-1.4.10 \
-	$(VBOX_PATH_X11_ROOT)/mesa-7.2/include \
-	$(VBOX_PATH_X11_ROOT)/inputproto-1.9.99.902 \
-	$(VBOX_PATH_X11_ROOT)/libdrm-2.4.13 \
-	$(VBOX_PATH_X11_ROOT)/libpciaccess-0.10.8 \
-	$(VBOX_PATH_X11_ROOT)/pixman-0.16.0 \
-	$(VBOX_PATH_X11_ROOT)/randrproto-1.3.0 \
-	$(VBOX_PATH_X11_ROOT)/renderproto-0.11 \
-	$(VBOX_PATH_X11_ROOT)/xextproto-7.1.1 \
-	$(VBOX_PATH_X11_ROOT)/xf86driproto-2.1.0 \
-	$(VBOX_PATH_X11_ROOT)/xorg-server-1.6.99-20090831 \
-	$(VBOX_PATH_X11_ROOT)/xorg-server-1.6.0-local \
-	$(VBOX_PATH_X11_ROOT)/xproto-7.0.18
+	/usr/include/drm \
+	/usr/include/X11/dri \
+	/usr/include/pixman-1 \
+	/usr/share/xorg-x11-server-source \
+	/usr/share/xorg-x11-server-source/fb \
+	/usr/share/xorg-x11-server-source/hw/xfree86/common \
+	/usr/share/xorg-x11-server-source/hw/xfree86/ddc \
+	/usr/share/xorg-x11-server-source/hw/xfree86/dixmods/extmod \
+	/usr/share/xorg-x11-server-source/hw/xfree86/dri \
+	/usr/share/xorg-x11-server-source/hw/xfree86/i2c \
+	/usr/share/xorg-x11-server-source/hw/xfree86/int10 \
+	/usr/share/xorg-x11-server-source/hw/xfree86/modes \
+	/usr/share/xorg-x11-server-source/hw/xfree86/os-support \
+	/usr/share/xorg-x11-server-source/hw/xfree86/os-support/bus \
+	/usr/share/xorg-x11-server-source/hw/xfree86/ramdac \
+	/usr/share/xorg-x11-server-source/hw/xfree86/shadowfb \
+	/usr/share/xorg-x11-server-source/hw/xfree86/vbe \
+	/usr/share/xorg-x11-server-source/hw/xfree86/vgahw \
+	/usr/share/xorg-x11-server-source/hw/xquartz/xpr \
+	/usr/share/xorg-x11-server-source/include \
+	/usr/share/xorg-x11-server-source/mi \
+	/usr/share/xorg-x11-server-source/miext/damage \
+	/usr/share/xorg-x11-server-source/randr \
+	/usr/share/xorg-x11-server-source/Xext \
+	/usr/share/xorg-x11-server-source/render \
+	/usr/share/xorg-x11-server-source/hw/xfree86/parser
 vboxvideo_drv_17_INCS += $(PATH_ROOT)/src/VBox/Runtime/include
 vboxvideo_drv_17_SOURCES := $(vboxvideo_drv_15_SOURCES)
 
@@ -239,7 +251,7 @@ vboxvideo_drv_17_SOURCES := $(vboxvideo_drv_15_SOURCES)
 #
 # vboxvideo_drv_18
 #
-DLLS += vboxvideo_drv_18
+#DLLS += vboxvideo_drv_18
 vboxvideo_drv_18_TEMPLATE = VBOXGUESTR3XORGMOD
 vboxvideo_drv_18_CFLAGS := $(vboxvideo_drv_70_CFLAGS)
 vboxvideo_drv_18_DEFS := $(vboxvideo_drv_15_DEFS)
@@ -266,7 +278,7 @@ vboxvideo_drv_18_SOURCES := $(vboxvideo_drv_15_SOURCES)
 #
 # vboxvideo_drv_19
 #
-DLLS += vboxvideo_drv_19
+#DLLS += vboxvideo_drv_19
 vboxvideo_drv_19_TEMPLATE = VBOXGUESTR3XORGMOD
 vboxvideo_drv_19_CFLAGS := $(vboxvideo_drv_70_CFLAGS)
 vboxvideo_drv_19_DEFS := $(vboxvideo_drv_15_DEFS)
@@ -292,7 +304,7 @@ vboxvideo_drv_19_SOURCES := $(vboxvideo_drv_15_SOURCES)
 
 # Check the undefined symbols in the X.Org modules against lists of allowed
 # symbols.  Not very elegant, but it will catch problems early.
-ifdef VBOX_WITH_TESTCASES
+ifdef NOT_VBOX_WITH_TESTCASES
 # ifndef VBOX_ONLY_ADDITIONS
   if1of ($(KBUILD_TARGET),linux solaris)
    ifeq ($(KBUILD_HOST_ARCH),$(KBUILD_TARGET_ARCH))
-- 
1.7.3.4

